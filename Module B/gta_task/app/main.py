from flask import Flask, request, session, render_template, redirect































































































































import sqlite3































































































































import os































































































































































































































































app = Flask(__name__)































































































































import random































































































































































































































































def get_dialogues():































































































































    quotes = [































































































































        ("CJ", "Grove Street... Home. At least it was before I got kicked out."),































































































































        ("Big Smoke", "All you had to do was follow the damn train, CJ!"),































































































































        ("Trevor", "What is wrong with you people?!"),































































































































        ("Franklin", "You know what, man? You alright."),































































































































        ("Lester", "You're looking for trouble, or something else?"),































































































































        ("Michael", "I miss the '80s... simpler times."),































































































































        ("Lamar", "You big yee-yee ass haircut havinâ€™!"),































































































































        ("Ron", "I hear the FIB has ears everywhere."),































































































































        ("Steve", "The less you know, the better."),































































































































        ("Tony", "Nothing happens in this city without my say so.")































































































































    ]































































































































    return random.sample(quotes, 4)































































































































































































































































app.secret_key = 'super_secret_key'































































































































DB_PATH = "app/database.db"































































































































FLAG = "flag{AEZAKMI_h4ck3rz}"































































































































































































































































def init_db():































































































































    os.makedirs(os.path.dirname(DB_PATH), exist_ok=True)































































































































    if not os.path.exists(DB_PATH):































































































































        conn = sqlite3.connect(DB_PATH)































































































































        c = conn.cursor()































































































































        c.execute('CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, password TEXT)')































































































































        users = [































































































































            ('cj', 'grovestreet'),































































































































            ('bigsmoke', 'number9large'),































































































































            ('rider', 'smokewater'),































































































































            ('franklin', 'fr4nklin123'),































































































































            ('trevor', 'chaos_is_me'),































































































































            ('michael', 'family_man'),































































































































            ('lamar', 'yeeeyeeass'),































































































































            ('tony', 'nightlife2020'),































































































































            ('lester', 'crippledbrains'),































































































































            ('devin', 'westonmoney'),































































































































            ('ron', 'airtrailer69'),































































































































            ('chef', 'boomtime'),































































































































            ('steve', 'fbiagent'),































































































































            ('dave', 'undercover42'),































































































































            ('admin', 'p4ssw0rdadm1n')































































































































        ]































































































































        c.executemany('INSERT INTO users (username, password) VALUES (?, ?)', users)































































































































































































































































        c.execute('CREATE TABLE secrets (id INTEGER PRIMARY KEY, flag TEXT)')































































































































        c.execute('INSERT INTO secrets (flag) VALUES (?)', (FLAG,))































































































































































































































































        c.execute('CREATE TABLE missions (id INTEGER PRIMARY KEY, name TEXT, location TEXT)')































































































































        missions = [































































































































            ('Steal the Flag', 'Downtown'),































































































































            ('flag{this_is_fake}', 'Alamo Sea'),































































































































            ('flag{almost_there}', 'Grapeseed'),































































































































            ('Capture the Bag', 'Blaine County'),































































































































            ('Final Flag', 'Fort Zancudo')































































































































        ]































































































































        c.executemany('INSERT INTO missions (name, location) VALUES (?, ?)', missions)































































































































































































































































        c.execute('CREATE TABLE fake_flags (id INTEGER PRIMARY KEY, text TEXT)')































































































































        fake_flags = [































































































































            ('flag{not_this_one}',),































































































































            ('flag{try_harder123}',),































































































































            ('flag{close_but_no}',),































































































































            ('flag{definitely_not_flag}',),































































































































            ('flag{admin_would_be_proud}',)































































































































        ]































































































































        c.executemany('INSERT INTO fake_flags (text) VALUES (?)', fake_flags)































































































































































































































































        conn.commit()































































































































        conn.close()































































































































































































































































@app.route('/')































































































































def index():































































































































    dialogues = get_dialogues()































































































































    return render_template('index.html', user=session.get('user'), dialogues=dialogues)































































































































































































































































@app.route('/login', methods=['POST'])































































































































def login():































































































































    username = request.form['username']































































































































    password = request.form['password']































































































































    conn = sqlite3.connect(DB_PATH)































































































































    c = conn.cursor()































































































































    c.execute("SELECT * FROM users WHERE username=? AND password=?", (username, password))































































































































    result = c.fetchone()































































































































    conn.close()































































































































    if result:































































































































        session['user'] = username































































































































    return redirect('/')































































































































































































































































@app.route('/logout')































































































































def logout():































































































































    session.clear()































































































































    return redirect('/')































































































































































































































































@app.route('/search', methods=['GET', 'POST'])































































































































def search():































































































































    dialogues = get_dialogues()































































































































    results = []































































































































    if request.method == 'POST':































































































































        term = request.form['term']































































































































        conn = sqlite3.connect(DB_PATH)































































































































        c = conn.cursor()































































































































        query = f"SELECT name, location FROM missions WHERE name LIKE '%{term}%'"































































































































        try:































































































































            c.execute(query)































































































































            results = c.fetchall()































































































































        except Exception as e:































































































































            results = [(str(e), '')]































































































































        conn.close()































































































































    return render_template('search.html', results=results, dialogues=dialogues)































































































































@app.route('/flag')































































































































def flag():































































































































    if session.get('user') == 'admin':































































































































        conn = sqlite3.connect(DB_PATH)































































































































        c = conn.cursor()































































































































        c.execute("SELECT flag FROM secrets LIMIT 1")































































































































        flag = c.fetchone()[0]































































































































        conn.close()































































































































        return f"<h3>Congrats! Here is your flag: {flag}</h3>"































































































































    return "Access Denied"































































































































































































































































if __name__ == '__main__':































































































































    init_db()































































































































    app.run(host='0.0.0.0', port=7010)




































































































































































































































































































































































































































































































































































































































































































































































































































@app.route('/game')
def game():
    return render_template('game.html', user=session.get('user'), dialogues=get_dialogues())
